<script>
  function scrollToSection(id) {
    var element = document.getElementById(id);
    if (element) {
      element.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  }
</script>

# Dataset Variable Explorer

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Load necessary libraries
library(reactable)
library(readxl)
library(dplyr)
library(htmltools)

# Define the base URL for your bookdown site
base_url <- "https://n-christie.github.io/register_reloc_age/appendix.html"

# Load the dataset from Excel
metadata <- read_excel("tables/Dataset_variable_lists.xlsx")

# Ensure Notes is treated as character and replace NA with empty strings
metadata <- metadata %>%
  mutate(Notes = ifelse(is.na(Notes), "", as.character(Notes)))

# Manually replace specific Markdown-style links in Notes with absolute URLs
metadata <- metadata %>%
  mutate(
    Notes = gsub("\\[partners\\]\\(#partners\\)", 
                 paste0("<a href='", base_url, "#partners'>partners</a>"), 
                 Notes),
    Notes = gsub("\\[visits\\]\\(#visits\\)", 
                 paste0("<a href='", base_url, "#visits'>visits</a>"), 
                 Notes)
  )

# Render reactable with Notes as a separate column and Dataset name in expandable section
reactable(
  metadata %>% select(`Variable name`, `Description - SWE`, `Description - ENG`, `Notes`), # Include Notes in main columns
  filterable = TRUE,                                  # Enable column filtering
  style = list(fontSize = "12px"), 
  searchable = TRUE,                                  # Enable global search
  pagination = TRUE,                                  # Enable pagination
  defaultPageSize = 20,                               # Show 20 rows per page
  highlight = TRUE,                                   # Highlight rows on hover
  bordered = TRUE,                                    # Add borders for a clear structure
  striped = TRUE,                                     # Alternating row colors for readability
  columns = list(
    `Variable name` = colDef(name = "Variable Name"),  
    `Description - SWE` = colDef(name = "Description (SWE)"),
    `Description - ENG` = colDef(name = "Description (ENG)"),
    Notes = colDef(html = TRUE, name = "Notes")        # Render Notes as HTML for clickable links
  ),
  # Set up expandable row details to include additional variables, including Dataset name
  details = function(index) {
    row_data <- metadata[index, ]
    htmltools::tags$div(
      style = "padding: 10px;",
      htmltools::tags$strong("Dataset name: "), row_data$`Dataset name`, htmltools::tags$br(),
      htmltools::tags$strong("Dataset description: "), row_data$`Dataset description`, htmltools::tags$br(),
      htmltools::tags$strong("Observations in Dataset: "), row_data$`Observations in Dataset`, htmltools::tags$br(),
      htmltools::tags$strong("Location: "), row_data$Location, htmltools::tags$br(),
      htmltools::tags$strong("Source: "), row_data$Source, htmltools::tags$br(),
      htmltools::tags$strong("Delivery file: "), row_data$`Delivery file`, htmltools::tags$br(),
      htmltools::tags$strong("Link: "), htmltools::tags$a(href = row_data$Link, target = "_blank", row_data$Link)
    )
  }
)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
library(reactable)
library(readxl)
library(dplyr)
library(htmltools)
library(crosstalk)

base_url <- "https://n-christie.github.io/register_reloc_age/appendix.html"

# ---- Load and clean data ----
metadata <- read_excel("tables/Dataset_variable_lists.xlsx") %>%
  mutate(
    Notes = ifelse(is.na(Notes), "", as.character(Notes)),
    Notes = gsub("\\[partners\\]\\(#partners\\)",
                 paste0("<a href='", base_url, "#partners'>partners</a>"),
                 Notes),
    Notes = gsub("\\[visits\\]\\(#visits\\)",
                 paste0("<a href='", base_url, "#visits'>visits</a>"),
                 Notes),
    .key = paste0("row_", row_number())
  )

# ---- Table data (unchanged columns) ----
tbl_df <- metadata %>%
  select(.key, `Variable name`, `Description - SWE`, `Description - ENG`, Notes)

# ---- Filter data (clean NA / blanks!) ----
clean_cat <- function(x) {
  x <- as.character(x)
  x[is.na(x) | trimws(x) == ""] <- "(missing)"
  x
}

filter_df <- metadata %>%
  transmute(
    .key,
    `Dataset name`  = clean_cat(`Dataset description`),
    Location        = clean_cat(Location),
    Source          = clean_cat(Source),
    `Delivery file` = clean_cat(`Delivery file`)
  )

# ---- Crosstalk shared data ----
shared_tbl <- SharedData$new(tbl_df, key = ~.key, group = "var_explorer")
shared_filters <- SharedData$new(filter_df, key = ~.key, group = "var_explorer")

# ---- Dropdown menus (Popular Movies style) ----
# IMPORTANT: multiple = TRUE
# Clearing all selections = show ALL rows
filters_ui <- div(
  style = "
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
    margin-bottom: 12px;
  ",
  filter_select("f_source",   "Providor",        shared_filters, ~Source,          multiple = TRUE),
  filter_select("f_dataset",  "Dataset",       shared_filters, ~`Dataset name`,  multiple = TRUE),
  #filter_select("f_location", "Location",      shared_filters, ~Location,        multiple = TRUE),
  #filter_select("f_delivery", "Delivery file", shared_filters, ~`Delivery file`, multiple = TRUE)
)

# ---- Key â†’ full-row lookup for details ----
meta_list <- split(metadata, metadata$.key)

# ---- Reactable (same appearance as before) ----
tbl <- reactable(
  shared_tbl,
  searchable = TRUE,
  pagination = TRUE,
  defaultPageSize = 20,
  highlight = TRUE,
  bordered = TRUE,
  striped = TRUE,
  style = list(fontSize = "12px"),
  columns = list(
    .key = colDef(show = FALSE),
    `Variable name` = colDef(name = "Variable Name"),
    `Description - SWE` = colDef(name = "Description (SWE)"),
    `Description - ENG` = colDef(name = "Description (ENG)"),
    Notes = colDef(html = TRUE, name = "Notes")
  ),
  details = function(index) {
    key <- shared_tbl$data()[index, ".key", drop = TRUE]
    if (is.data.frame(key)) key <- key[[1]]
    key <- as.character(key)

    row_data <- meta_list[[key]]

    tags$div(
      style = "padding: 10px;",
      tags$strong("Dataset name: "), row_data$`Dataset name`, tags$br(),
      tags$strong("Dataset description: "), row_data$`Dataset description`, tags$br(),
      tags$strong("Observations in Dataset: "), row_data$`Observations in Dataset`, tags$br(),
      tags$strong("Location: "), row_data$Location, tags$br(),
      tags$strong("Source: "), row_data$Source, tags$br(),
      tags$strong("Delivery file: "), row_data$`Delivery file`, tags$br(),
      tags$strong("Link: "),
      tags$a(href = row_data$Link, target = "_blank", row_data$Link)
    )
  }
)

# ---- Render ----
htmltools::browsable(htmltools::tagList(filters_ui, tbl))

```
```